services:
  bug-report:
    image: cmucal/cabot-bug-report:${CABOT_LAUNCH_IMAGE_TAG:-latest}
    build:
      context: ./docker
      x-bake:
        tags:
          - ${REGISTRY:-cmucal}/cabot-bug-report
        platforms:
          - linux/amd64
          - linux/arm64
        output:
          - type=registry
    volumes:
      - /dev:/dev
      - /sys/devices:/sys/devices
      - /run/dbus:/run/dbus
      - /run/udev:/run/udev:ro
      - /var/run/dbus:/var/run/dbus
      - /lib/modules:/lib/modules:ro
      - /opt/cabot:/opt/cabot
      - ${LOGDIR:-/opt/cabot/docker/home/.ros/log}:/log
      - ${RUNDIR:-.}/content:/home/developer/content
      - ${RUNDIR:-.}/error:/home/developer/error
      - ${RUNDIR:-.}/issue_list.txt:/home/developer/issue_list.txt
# for systemctl
      - /run/systemd/system:/run/systemd/system
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
      - /sys/fs/cgroup:/sys/fs/cgroup
# for systemctl --user
      - /run/user:/run/user
      - /usr/bin/docker:/usr/bin/docker
      - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - CABOT_NAME
      - BOX_CLIENT_ID
      - BOX_CLIENT_SECRET
      - BOX_ENTERPRISE_ID
      - BOX_FOLDER_ID
      - GIT_USERNAME
      - GIT_PASSWORD
      - HOST_GID
      - HOST_TZ
      - HOST_UID
      - LOGDIR
      - NAS_IP
      - NAS_IP_WIRED
      - NAS_PASSWORD
      - NAS_SHARE_DIR
      - NAS_USER
      - REPO_NAME
      - REPO_NAME_FOR_ERROR
      - REPO_OWNER
      - REPO_OWNER_FOR_ERROR
      - SLACK_TOKEN
      - WIFI_DROUTE
      - WIFI_METRIC
      - WIFI_SSID
    privileged: true
# device, bluetooth
    devices:
      - /dev/dri
# device, bluetoo
    network_mode: host
    command: ./submit_report.sh